version: '3.7'

name: 'etp-e2e'
include:
  - ../../etp-core/docker/docker-compose.yml


services:
  backend:
    build: ../../etp-core/etp-backend
    environment:
      # solita.etp.config
      DB_HOST: db
      SMTP_HOST: smtp
      SMTP_PORT: 25
      LASKUTUS_SFTP_HOST: sftp
      LASKUTUS_SFTP_PORT: 22
      # TODO: What is this?
      # SERVICE_HOST: frontend:3009
      # TODO: Täytyy muutta envistä luettavaksi. Ehkä.
      # S3:
    env_file: 
      - ./backend.env
    depends_on:
      db:
        condition: service_started
      migration-runner:
        condition: service_completed_successfully


  frontend:
    build: ../../etp-front
    environment:
      WEBPACK_PROXY_TARGET: http://backend:8080
      WEBPACK_ALLOWED_HOSTS: all
      WEBPACK_HOST: 0.0.0.0
      WEBPACK_PORT: 3009

    # TODO: This makes GHA give 127
    #    healthcheck:
    #  test: curl -k https://localhost:3009 || exit 1
    #  interval: 1m30s
    #  timeout: 10s
    #  retries: 3
    #  start_period: 2m
    ports:
      - 127.0.0.1:3009:3009
    depends_on:
      backend:
        condition: service_started

  migration-runner:
    build: ../../etp-core/etp-db
      #context: ../../etp-core/etp-db
        #dockerfile: e2e.Dockerfile
    environment:
      DB_URL: jdbc:postgresql://db:5432/etp_dev
    command:
      ./db.sh migrate test
    depends_on:
      db:
        condition: service_started

  cypress:
    image: "cypress/included:13.6.4"
    depends_on:
      frontend:
        condition: service_healthy
    working_dir: /e2e
    volumes:
      - .:/e2e
    environment:
      CYPRESS_baseUrl: https://frontend:3009
